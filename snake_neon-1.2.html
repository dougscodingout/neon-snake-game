<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Neon Snake — v1.5 Eclipse Expansion (Full Audio Codex)</title>
<style>
  html,body{height:100%;margin:0;background:radial-gradient(100% 120% at 50% 0%, #020611, #000);color:#dff;font-family:system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;overflow:hidden;}
  .center{position:fixed;inset:0;display:grid;place-items:center}
  .logo{font-weight:800;letter-spacing:.12em;text-transform:uppercase;font-size:clamp(24px,4vw,44px);color:#fff;text-shadow:0 0 12px #00eaff,0 0 36px #00eaff;animation:flicker 4s linear infinite;}
  .subtitle{opacity:.85;font-size:clamp(12px,2.2vw,16px);letter-spacing:.3em;text-transform:uppercase;color:#9ff}
  .start{padding:14px 22px;border-radius:999px;border:1px solid #0ff6;background:linear-gradient(180deg,#022531,#001219);color:#e7ffff;font-weight:700;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease,background .2s ease;box-shadow:0 0 12px #00eaff44;}
  .start:hover{transform:translateY(-1px);box-shadow:0 0 22px #00eaffaa,inset 0 0 22px #00eaff22}
  .fadeout{animation:fadeout .8s ease forwards}
  @keyframes flicker{0%,100%{opacity:1}48%{opacity:.96}50%{opacity:.7}52%{opacity:1}}
  @keyframes fadeout{to{opacity:0;visibility:hidden}}
  canvas{display:block;margin:auto;border-radius:22px;box-shadow:0 0 30px #0ff6,inset 0 0 40px #00ffee22;transition:box-shadow .25s ease,filter .3s ease;}
</style>
</head>
<body>
  <div class="center">
    <div class="splash" id="splash">
      <div class="logo">NEON SNAKE</div>
      <div class="subtitle">ECLIPSE EXPANSION — v1.5</div>
      <button class="start" id="startBtn">Iniciar Experiência</button>
    </div>
  </div>
  <canvas id="cv" width="720" height="720" style="display:none"></canvas>
<script>
let audioCtx, master, delay, feedback, tempo=100, beatTimer;

function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  // garante inicio do audio após clique em navegadores mais chatos
  if (audioCtx.state === 'suspended') audioCtx.resume();
  master = audioCtx.createGain(); master.gain.value = 0.12; master.connect(audioCtx.destination);
  delay = audioCtx.createDelay(); delay.delayTime.value = 0.25;
  feedback = audioCtx.createGain(); feedback.gain.value = 0.28;
  delay.connect(feedback).connect(delay); delay.connect(master);
  startBass(); startBeat();
}

function startBass(){
  const bass = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  bass.type = 'sawtooth'; bass.frequency.value = 55; gain.gain.value = 0.08;
  bass.connect(gain).connect(master); bass.start();
  window.bassLayer = { osc:bass, gain };
}

function startBeat(){
  const play = () => { playKick(); beatTimer = setTimeout(play, (60/tempo)*1000); };
  play();
}

function playKick(){
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  const t = audioCtx.currentTime; o.type='sine';
  o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(40,t+0.25);
  g.gain.setValueAtTime(0.4,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
  o.connect(g).connect(master); o.start(t); o.stop(t+0.3);
}

function triggerSlowMotionAudio(){
  if(!audioCtx) return;
  feedback.gain.linearRampToValueAtTime(0.55,audioCtx.currentTime+0.3);
  bassLayer.osc.frequency.linearRampToValueAtTime(30,audioCtx.currentTime+0.3);
  master.gain.linearRampToValueAtTime(0.08,audioCtx.currentTime+0.3);
  setTimeout(() => restoreAudioTempo(), 3000);
}
function restoreAudioTempo(){
  feedback.gain.linearRampToValueAtTime(0.28,audioCtx.currentTime+0.4);
  bassLayer.osc.frequency.linearRampToValueAtTime(55,audioCtx.currentTime+0.4);
  master.gain.linearRampToValueAtTime(0.12,audioCtx.currentTime+0.4);
}

const cv = document.getElementById('cv'); const ctx = cv.getContext('2d');
const btn = document.getElementById('startBtn'); const splash = document.getElementById('splash');

btn.addEventListener('click', startGame);
btn.addEventListener('touchstart', startGame, {passive:true});

function startGame(e){
  e?.preventDefault?.();
  splash.classList.add('fadeout'); initAudio();
  setTimeout(() => {
    splash.remove();
    cv.style.display='block';
    // garante que as teclas vão para o canvas
    cv.tabIndex = 0; 
    cv.focus();
    setTimeout(() => cv.focus(), 0); // refoco após pintura
    initGame();
  }, 900);
}

let snake=[{x:10,y:10},{x:9,y:10},{x:8,y:10}],
    dir={x:1,y:0},
    apple={x:5,y:5},
    powerUps=[], slowMotion=false, slowTimer=0, score=0;

const CELL=24, COLS=30, ROWS=30;
// Controle de velocidade (fixo e previsível)
let lastStep=0;                 // timestamp do último passo lógico
let BASE_STEP_MS=140;           // atraso base entre passos (mais alto = mais lento)
let MIN_STEP_MS=80;             // limite inferior para não ficar rápido demais
let SPEEDUP_EVERY=10;           // a cada X pontos, acelera um pouco

function initGame(){
  // handler robusto: setas + WASD, sem 180°
  const keyHandler = (e) => {
    // e.code é mais estável entre layouts no Mac
    const map = {
      ArrowUp:{x:0,y:-1},   KeyW:{x:0,y:-1},
      ArrowDown:{x:0,y:1},  KeyS:{x:0,y:1},
      ArrowLeft:{x:-1,y:0}, KeyA:{x:-1,y:0},
      ArrowRight:{x:1,y:0}, KeyD:{x:1,y:0}
    };
    const newDir = map[e.code];
    if (newDir){
      e.preventDefault(); // evita scroll/navegação com setas
      if (!(newDir.x === -dir.x && newDir.y === -dir.y)) {
        dir = newDir;
      }
    }
  };
  // passive:false para o preventDefault funcionar
  window.addEventListener('keydown', keyHandler, {passive:false});
  loop();
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

function update(){
  // passo lógico desacoplado do render (fix timestep)
  const now = performance.now();
  // aceleração suave por score
  const accel = Math.floor(score / SPEEDUP_EVERY) * 10; // -10ms a cada 10 pontos
  const targetStep = Math.max(MIN_STEP_MS, BASE_STEP_MS - accel);
  const slowFactor = slowMotion ? 3 : 1; // 3x mais lento no slow motion
  const step = targetStep * slowFactor;
  if (now - lastStep < step) return; // ainda não é hora de avançar
  lastStep = now;

  const head={x:(snake[0].x+dir.x+COLS)%COLS,y:(snake[0].y+dir.y+ROWS)%ROWS};

  if(head.x===apple.x&&head.y===apple.y){
    score++;
    apple=randomCell();
    spawnPowerUp();
    playEat();
  } else {
    snake.pop();
  }

  for(let i=powerUps.length-1;i>=0;i--){
    if(head.x===powerUps[i].x&&head.y===powerUps[i].y){
      activateSlowMotion();
      powerUps.splice(i,1);
    }
  }

  // colisão com o próprio corpo (somente fora do slow motion)
  if(!slowMotion && snake.some((p,i)=>i>2 && p.x===head.x && p.y===head.y)){
    // reset simples
    snake=[{x:10,y:10},{x:9,y:10},{x:8,y:10}];
    dir={x:1,y:0};
    apple=randomCell();
    powerUps=[]; slowMotion=false; slowTimer=0; score=0;
    return;
  }

  snake.unshift(head);

  if(slowMotion && Date.now()>slowTimer){
    slowMotion=false;
    cv.style.filter='brightness(1) saturate(1) blur(0px)';
    restoreAudioTempo?.();
  }
}

function draw(){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,cv.width,cv.height);
  ctx.strokeStyle='rgba(0,255,255,0.15)'; ctx.beginPath();
  for(let i=1;i<COLS;i++){ctx.moveTo(i*CELL+.5,0);ctx.lineTo(i*CELL+.5,cv.height);}
  for(let j=1;j<ROWS;j++){ctx.moveTo(0,j*CELL+.5);ctx.lineTo(cv.width,j*CELL+.5);}
  ctx.stroke();
  orb(apple.x,apple.y,'#ff0');
  powerUps.forEach(p=>orb(p.x,p.y,'#0ff'));
  ctx.fillStyle=slowMotion?'#fff':'#0ff';
  snake.forEach(p=>ctx.fillRect(p.x*CELL+2,p.y*CELL+2,CELL-4,CELL-4));
  if(slowMotion) haloEffect();
}

function orb(x,y,color){
  const px=x*CELL+CELL/2, py=y*CELL+CELL/2;
  const g=ctx.createRadialGradient(px,py,2,px,py,10);
  g.addColorStop(0,'#fff'); g.addColorStop(.3,color); g.addColorStop(1,'#0000');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(px,py,10,0,Math.PI*2); ctx.fill();
}

function haloEffect(){
  const cx=cv.width/2, cy=cv.height/2, r=Math.hypot(cx,cy)*0.9;
  const g=ctx.createRadialGradient(cx,cy,r*0.2,cx,cy,r);
  g.addColorStop(0,'rgba(255,255,255,0.25)');
  g.addColorStop(0.4,'rgba(42,0,79,0.22)');
  g.addColorStop(1,'rgba(0,0,0,0)');
  ctx.globalCompositeOperation='screen';
  ctx.fillStyle=g; ctx.fillRect(0,0,cv.width,cv.height);
  ctx.globalCompositeOperation='source-over';
}

function activateSlowMotion(){
  slowMotion=true; slowTimer=Date.now()+3000;
  cv.style.filter='brightness(1.3) saturate(1.6) blur(1px)';
  triggerSlowMotionAudio();
}

function randomCell(){
  return { x:Math.floor(Math.random()*COLS), y:Math.floor(Math.random()*ROWS) };
}

function spawnPowerUp(){
  if(Math.random()<0.4) powerUps.push(randomCell());
}

function playEat(){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type='square'; o.frequency.value=520; g.gain.value=0.2;
  o.connect(g).connect(master);
  const t=audioCtx.currentTime; o.start(t);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.25);
  o.stop(t+0.25);
}
</script>
</body>
</html>
